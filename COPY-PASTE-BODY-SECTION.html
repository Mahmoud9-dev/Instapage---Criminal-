<!-- ================================================ -->
<!-- COPY THIS ENTIRE BLOCK TO INSTAPAGE BODY SECTION -->
<!-- PASTE AT THE BOTTOM OF BODY SECTION              -->
<!-- ================================================ -->

<!-- GTM NoScript (Required) -->
<noscript>
  <iframe
    src="https://www.googletagmanager.com/ns.html?id=GTM-TC4MXD2T"
    height="0"
    width="0"
    style="display: none; visibility: hidden"
  ></iframe>
</noscript>

<!-- Phase 4: Optimized JavaScript Performance -->
<script>
  // Remove existing lazy loading script and replace with this optimized version
  (function () {
    "use strict";

    // Modern ES2020 optimized lazy loading
    const lazyLoadConfig = {
      root: null,
      rootMargin: "50px",
      threshold: 0.01,
    };

    // Enhanced lazy loading with WebP support
    const lazyImageObserver = new IntersectionObserver((entries, observer) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const img = entry.target;

          // WebP format detection and loading
          if (img.dataset.src) {
            const webpSrc = img.dataset.src.replace(
              /\.(jpg|jpeg|png)$/i,
              ".webp"
            );
            const originalSrc = img.dataset.src;

            // Test WebP support
            const webpImg = new Image();
            webpImg.onload = () => {
              img.src = webpSrc;
              img.classList.add("loaded");
            };
            webpImg.onerror = () => {
              img.src = originalSrc;
              img.classList.add("loaded");
            };
            webpImg.src = webpSrc;

            img.classList.remove("lazy");
            observer.unobserve(img);
          }
        }
      });
    }, lazyLoadConfig);

    // Apply to all images
    const initializeLazyLoading = () => {
      document.querySelectorAll("img[data-src]:not(.loaded)").forEach((img) => {
        img.classList.add("lazy");
        lazyImageObserver.observe(img);
      });
    };

    // Initialize on DOM ready
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initializeLazyLoading);
    } else {
      initializeLazyLoading();
    }

    // Optimized chat widget loading (fix SSL error)
    const loadChatWidget = () => {
      try {
        if (typeof SU5UQUtFUl9DSEFUX1VSTE === "undefined") {
          const script = document.createElement("script");
          script.async = true;
          script.src = "https://intaker.co/dist/chat-widget.min.js";
          script.onerror = () => {
            console.warn("Chat widget failed to load");
          };
          document.body.appendChild(script);
        }
      } catch (error) {
        console.warn("Chat widget initialization failed:", error);
      }
    };

    // Load chat widget after 3 seconds to improve initial page load
    setTimeout(loadChatWidget, 3000);

    // Performance monitoring
    if (typeof PerformanceObserver !== "undefined") {
      const observer = new PerformanceObserver((list) => {
        for (const entry of list.getEntries()) {
          if (entry.entryType === "largest-contentful-paint") {
            // Track LCP improvements
            console.log("LCP:", entry.startTime);
          }
          if (entry.entryType === "layout-shift") {
            // Track CLS improvements
            if (!entry.hadRecentInput) {
              console.log("CLS:", entry.value);
            }
          }
        }
      });

      observer.observe({
        entryTypes: ["largest-contentful-paint", "layout-shift"],
      });
    }

    // Remove unused JavaScript from original implementation
    // Clean up any remaining references to old lazy loading
    const cleanupOldScripts = () => {
      // Remove old lazy loading variables if they exist
      if (typeof lazyImages !== "undefined") delete window.lazyImages;
      if (typeof lazyBackground !== "undefined") delete window.lazyBackground;
      if (typeof lazyIframe !== "undefined") delete window.lazyIframe;
      if (typeof lazyScripts !== "undefined") delete window.lazyScripts;
    };

    cleanupOldScripts();
  })();

  // Google Ads Conversion Tracking (Optimized)
  function gtag_report_conversion(url) {
    const callback = function () {
      if (typeof url != "undefined") {
        window.location = url;
      }
    };

    if (typeof gtag !== "undefined") {
      gtag("event", "conversion", {
        send_to: "AW-973233442/5N3MCMzytaoZEKK6idAD",
        event_callback: callback,
      });
    }
    return false;
  }
</script>

<!-- Additional CSS for Image Optimization -->
<style>
  /* WebP Image Support */
  .webp img {
    image-rendering: -webkit-optimize-contrast;
  }

  /* Lazy Loading Animation */
  .lazy {
    filter: blur(5px);
    opacity: 0.5;
    transition: filter 0.3s, opacity 0.3s;
  }

  .lazy.loaded {
    filter: blur(0);
    opacity: 1;
  }

  /* Performance CSS - Reduce Repaints */
  img {
    will-change: auto;
    transform: translateZ(0);
  }

  /* Prevent Font Flash */
  .font-loading {
    visibility: hidden;
  }

  .fonts-loaded .font-loading {
    visibility: visible;
  }

  /* Critical Above-the-Fold Styles */
  .hero-section img,
  .banner img {
    loading: eager !important;
  }

  .hero-section img:not(.lazy),
  .banner img:not(.lazy) {
    opacity: 1 !important;
    filter: none !important;
  }
</style>
